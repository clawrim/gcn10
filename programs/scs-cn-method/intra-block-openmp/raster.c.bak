#include "global.h"

typedef struct {
    const char *filename;
    Raster **rast;
} ReadArgs;

void *read_raster_thread(void *args) {
    ReadArgs *rargs = (ReadArgs *)args;
    *rargs->rast = read_raster(rargs->filename);
    return NULL;
}

Raster *allocate_raster(int nrows, int ncols, double no_data_value) {
    Raster *rast = malloc(sizeof(Raster));
    if (!rast) {
        fprintf(stderr, "error: alloc raster structure\n");
        return NULL;
    }
    rast->nrows = nrows;
    rast->ncols = ncols;
    rast->no_data_value = no_data_value;
    rast->data = aligned_alloc(64, nrows * ncols * sizeof(double));
    if (!rast->data) {
        fprintf(stderr, "error: alloc raster data\n");
        free(rast);
        return NULL;
    }
    return rast;
}

void free_raster(Raster *rast) {
    if (rast) {
        free(rast->data);
        free(rast);
    }
}

Raster *read_raster(const char *filename) {
    GDALAllRegister();
    GDALDatasetH ds = GDALOpen(filename, GA_ReadOnly);
    if (!ds) {
        fprintf(stderr, "error: open %s\n", filename);
        return NULL;
    }
    int rows = GDALGetRasterYSize(ds);
    int cols = GDALGetRasterXSize(ds);
    double no_data = GDALGetRasterNoDataValue(GDALGetRasterBand(ds, 1), NULL);
    Raster *rast = allocate_raster(rows, cols, no_data);
    if (!rast) {
        GDALClose(ds);
        return NULL;
    }
    GDALRasterBandH band = GDALGetRasterBand(ds, 1);
    if (GDALRasterIO(band, GF_Read, 0, 0, cols, rows, rast->data, cols, rows, GDT_Float64, 0, 0) != CE_None) {
        fprintf(stderr, "error: read %s\n", filename);
        free_raster(rast);
        GDALClose(ds);
        return NULL;
    }
    GDALClose(ds);
    return rast;
}

Raster *read_raster_parallel(const char *filename, int num_threads) {
    Raster *rast;
    ReadArgs args = {filename, &rast};
    pthread_t thread;
    pthread_create(&thread, NULL, read_raster_thread, &args);
    pthread_join(thread, NULL);
    return rast;
}

void write_raster(const char *filename, Raster *rast, const char *ref_file) {
    GDALAllRegister();
    GDALDatasetH ref = GDALOpen(ref_file, GA_ReadOnly);
    if (!ref) {
        fprintf(stderr, "error: open %s\n", ref_file);
        return;
    }
    double gt[6];
    GDALGetGeoTransform(ref, gt);
    const char *proj = GDALGetProjectionRef(ref);
    char *opts[] = {"COMPRESS=LZW", "TILED=YES", NULL};
    GDALDatasetH ds = GDALCreate(GDALGetDriverByName("GTiff"), filename, rast->ncols, rast->nrows, 1, GDT_Float32, opts);
    if (!ds) {
        fprintf(stderr, "error: create %s\n", filename);
        GDALClose(ref);
        return;
    }
    GDALSetGeoTransform(ds, gt);
    GDALSetProjection(ds, proj);
    GDALRasterBandH band = GDALGetRasterBand(ds, 1);
    float *fdata = malloc(rast->nrows * rast->ncols * sizeof(float));
    if (!fdata) {
        GDALClose(ds);
        GDALClose(ref);
        return;
    }
    for (int i = 0; i < rast->nrows * rast->ncols; i++) {
        fdata[i] = (float)rast->data[i];
    }
    GDALSetRasterNoDataValue(band, (float)rast->no_data_value);
    if (GDALRasterIO(band, GF_Write, 0, 0, rast->ncols, rast->nrows, fdata, rast->ncols, rast->nrows, GDT_Float32, 0, 0) != CE_None) {
        fprintf(stderr, "error: write %s\n", filename);
    }
    free(fdata);
    GDALClose(ds);
    GDALClose(ref);
}
